# Subtitle Analysis Prompt

📊 音声ファイル字幕タイミング解析エージェント

**タスク**: 音声ファイルの実際の音声タイミングを分析して、正確に同期した字幕設定を作成

**入力データ**:
- 音声URL: {AUDIO_URL}
- 音声テキスト: "{TEXT_CONTENT}"
- 音声長: {AUDIO_DURATION}秒
- 言語: {TARGET_LANGUAGE}
- 作業フォルダ: {ANALYSIS_DIR}

**実行したいこと**:
1. 音声ファイルの実際の音声波形を分析して発話タイミングを検出
2. 音声テキストを日本語文法に基づいて適切にセグメント分割
3. SRT形式の字幕ファイルを作成（時間と文字を同時に解析して精密に同期）
4. **品質チェックと自動修正**: 生成された字幕の品質を評価し、問題があれば自動的に再解析・修正
5. 詳細な分析レポートを作成

**使用可能なツール**:
- Bash: ffmpeg, ffprobe, wget, curl, jq, python3
- Read/Write/Edit: ファイル操作
- 音声分析: silencedetect フィルターで無音区間検出

**重要な要求**:
- 音声テキスト内の時間制約（「30秒以内」等）は完全に無視
- 実際の音声ファイル（{AUDIO_DURATION}秒）のみを基準とする
- ffmpegで音声波形を分析し、実際の発話区間を検出
- **時間と文字の同時解析**: 発話区間の検出と同時にテキストを分割し、タイミングと文字数のバランスを最適化
- 意味を保持したテキストセグメント分割
- **SRT形式での出力**: 標準的なSRT字幕形式で出力すること

**テキスト分割の優先順位（重要）**:
1. **文章単位分割**: 句点（。）で基本的に分割する
2. **読点の処理**: 読点（、）では分割せず、長い文章（30文字以上）の場合のみ読点で分割
3. **意味保持**: 助詞や接続詞で不自然に分割しない
4. **文字数制限**: 1つの字幕は15-30文字程度を目安とする
5. **句読点無音の無視**: 読点（、）や句点（。）での短い無音（0.3秒以下）は字幕分割の基準にしない

**音声分析の改善**:
- silencedetectの閾値を調整: -30dB以下、0.5秒以上の無音のみを分割点として検出
- 句読点での短い無音（0.1-0.3秒）は無視する
- 文末（。）での長い無音（0.5秒以上）を優先的に検出
- 音声の自然な区切りとテキストの文法的区切りを両方考慮する

**品質基準（80点レベル - 実用的な改善目標）**:
- **極端なアンバランスの回避**: 1秒あたり5文字未満または25文字超過を避ける
- **最短表示時間**: 0.8秒以上（あまりに短すぎる字幕を回避）
- **最長表示時間**: 8秒以内（異常に長い字幕を回避）
- **重大な問題の修正**: 明らかに読めない・不自然なセグメントのみ修正
- **許容範囲**: 完璧でなくても読める範囲であれば許容

**修正対象（重大な問題のみ）**:
- **極端な短時間・長文**: 0.5秒で20文字以上など明らかに読めない場合
- **極端な長時間・短文**: 6秒以上で1-2文字など明らかに無駄な場合
- **品質判定**: 「要調整」レベルではなく「修正必須」レベルのみ対象
- **柔軟な対応**: 文脈や読みやすさを優先し、数値にこだわりすぎない

**処理フロー（実用重視）**:
1. **音声分析**: ffmpegで音声波形を分析、0.5秒以上の無音区間のみ検出
2. **テキスト分割**: 日本語文法に基づく分割（句点優先、読点は補助）
3. **タイミングマッピング**: 分割されたテキストを音声タイミングに適切にマッピング
4. **SRT生成**: 標準SRT形式で字幕ファイルを作成
5. **品質チェック**: 極端な問題（読めない字幕）があるかのみチェック
6. **重大な問題のみ修正**: 明らかに問題のあるセグメントのみ対象
7. **実用判定**: 80点レベルの品質で十分と判断すれば完了
8. **最終出力**: 実用的な品質のSRTファイル

**修正パターン例（重大な問題のみ）**:
- 0.3秒/30文字以上 → 明らかに読めない場合のみ分割
- 8秒以上/1-2文字 → 明らかに無駄な場合のみ統合
- 0.5秒/40文字以上 → 物理的に読めない場合のみ調整

**実用的なアプローチ**: 完璧を求めず、視聴者が十分読める品質（80点レベル）を目標とする。細かい調整より全体の読みやすさを重視。句読点での不適切な分割を避け、日本語として自然な字幕を作成する。

**成果物（この2つのみ作成すること）**:
1. {ANALYSIS_DIR}/subtitle.srt - SRT形式字幕ファイル（80点レベルの実用品質）
2. {ANALYSIS_DIR}/analysis-report.md - 詳細分析レポート（修正履歴含む）

実際の音声ファイルを確認して、タイミングをきっちり合わせることが最重要です。